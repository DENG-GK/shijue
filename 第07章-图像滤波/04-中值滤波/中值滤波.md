# 中值滤波

> 中值滤波是一种**非线性滤波**，它不做加权平均，而是简单粗暴地**取邻域内所有像素的中间值**。这种方法对椒盐噪声有奇效——因为极端的噪声值在排序后会被挤到两端，永远不会成为"中间值"！

---

## 📖 理论部分

### 1. 为什么需要中值滤波？

#### 1.1 均值滤波对椒盐噪声的无力

回顾一下均值滤波的问题：

```
椒盐噪声让均值滤波很头疼：

  假设邻域内有这些像素值：
  ┌────┬────┬────┐
  │ 98 │101 │ 99 │
  ├────┼────┼────┤     大部分像素在 100 左右
  │100 │  0 │102 │     但中心是一个"胡椒"噪声（纯黑=0）
  ├────┼────┼────┤
  │ 97 │103 │ 98 │
  └────┴────┴────┘

  均值滤波：
  新值 = (98+101+99+100+0+102+97+103+98) / 9
       = 798 / 9
       = 88.7

  问题：本来应该是 ~100，结果变成了 89
        噪声值 0 把平均值拉低了！

  如果噪声是 255（盐）：
  新值 = (98+101+99+100+255+102+97+103+98) / 9 = 117

  问题：本来应该是 ~100，结果变成了 117
        噪声值 255 把平均值拉高了！
```

#### 1.2 中值滤波的解决思路

```
中值滤波的核心思想：

  同样的邻域像素：[98, 101, 99, 100, 0, 102, 97, 103, 98]
                                        ↑ 噪声

  Step 1: 排序
  [0, 97, 98, 98, 99, 100, 101, 102, 103]
   ↑                   ↑               ↑
  最小值            中值(第5个)      最大值
  (噪声在这)                        (如果是盐噪声就在这)

  Step 2: 取中间值
  新值 = 99（排序后正中间的那个）

  太棒了！噪声值 0 被完全无视了！
  因为无论噪声是 0 还是 255，它排序后都在两端，
  永远不可能成为"中间值"！
```

```
中值的直观理解：

  ┌────────────────────────────────────────────────────┐
  │  "中值"就像投票选举中的"中位数选民"               │
  │                                                    │
  │  如果有 9 个人投票：                               │
  │    8 人选 A，1 人选 Z（极端选项）                  │
  │                                                    │
  │  用平均？→ Z 会影响结果                           │
  │  用中值？→ 排序后第 5 个人选的就是结果，Z 无影响  │
  │                                                    │
  │  中值天生对"少数极端值"免疫！                     │
  └────────────────────────────────────────────────────┘
```

---

### 2. 中值滤波的工作原理

#### 2.1 计算步骤

```
中值滤波的计算步骤（3×3 核）：

  原始图像：
  ┌────┬────┬────┬────┬────┐
  │ 45 │ 50 │ 55 │ 48 │ 52 │
  ├────┼────┼────┼────┼────┤
  │ 48 │ 52 │255 │ 50 │ 47 │    ← 255 是椒盐噪声（盐）
  ├────┼────┼────┼────┼────┤
  │ 50 │ 46 │ 51 │ 53 │ 49 │
  └────┴────┴────┴────┴────┘

  计算位置(1,2)处（噪声点 255）的新值：

  Step 1: 取出 3×3 邻域
  ┌────┬────┬────┐
  │ 50 │ 55 │ 48 │
  ├────┼────┼────┤
  │ 52 │255 │ 50 │
  ├────┼────┼────┤
  │ 46 │ 51 │ 53 │
  └────┴────┴────┘

  Step 2: 把所有值放入列表
  [50, 55, 48, 52, 255, 50, 46, 51, 53]

  Step 3: 排序
  [46, 48, 50, 50, 51, 52, 53, 55, 255]
                    ↑
                  中值（第5个）

  Step 4: 取中间值
  新值 = 51

  完美！255 的噪声被彻底消除了！
  新值 51 非常接近周围像素的真实值 (~50)
```

#### 2.2 线性 vs 非线性

```
中值滤波是非线性的：

  线性滤波（如均值、高斯）：
    output = w1×p1 + w2×p2 + ... + wn×pn
    → 可以用卷积核的矩阵乘法表示
    → 满足叠加性：f(a+b) = f(a) + f(b)

  非线性滤波（如中值）：
    output = median(p1, p2, ..., pn)
    → 涉及排序操作，无法用矩阵表示
    → 不满足叠加性

  ┌─────────────────────────────────────────────────┐
  │  线性滤波：可以写成卷积核                        │
  │            ┌───┬───┬───┐                         │
  │            │0.1│0.1│0.1│                         │
  │            │0.1│0.2│0.1│    → 一个确定的核       │
  │            │0.1│0.1│0.1│                         │
  │            └───┴───┴───┘                         │
  │                                                  │
  │  非线性滤波：没有固定的核                        │
  │            结果依赖于邻域内像素的实际数值分布    │
  │            需要对每个位置单独进行排序            │
  └─────────────────────────────────────────────────┘
```

---

### 3. 中值滤波的特点

```
中值滤波的优缺点：

  ✅ 优点：
  ┌──────────────────────────────────────────────────┐
  │ 1. 对椒盐噪声效果极佳（几乎完美去除）            │
  │ 2. 边缘保持效果好（不像均值那样模糊边缘）        │
  │ 3. 对异常值（outlier）有天然的免疫力            │
  │ 4. 不会产生不存在的灰度值（结果一定是邻域中的值）│
  └──────────────────────────────────────────────────┘

  ❌ 缺点：
  ┌──────────────────────────────────────────────────┐
  │ 1. 计算速度慢（需要排序，O(n log n) vs O(n)）   │
  │ 2. 对高斯噪声效果不如高斯滤波                    │
  │ 3. 可能会消除细小的线条和细节                    │
  │ 4. 核越大，计算越慢，细节丢失越多                │
  └──────────────────────────────────────────────────┘
```

```
边缘保持效果对比：

  原始边缘：        均值滤波后：        中值滤波后：
  │ 0  0  0│255│    │ 0  0│ 85│170│    │ 0  0  0│255│
  │ 0  0  0│255│    │ 0  0│ 85│170│    │ 0  0  0│255│
  │ 0  0  0│255│    │ 0  0│ 85│170│    │ 0  0  0│255│
       ↑                  ↑                  ↑
    锐利边缘          边缘变渐变          边缘保持锐利！

  为什么中值能保持边缘？
  在边缘处，邻域一半是黑(0)，一半是白(255)
  排序后：[0,0,0,0,0,255,255,255,255]
  中值刚好是边界两侧的值之一，不会出现中间值！
```

---

### 4. OpenCV 中的中值滤波

```
函数签名：

  cv2.medianBlur(src, ksize)
  ├── src   : 输入图像
  └── ksize : 核大小，必须是大于1的奇数（3, 5, 7, ...）
              注意：这里只给一个数，不是元组！

  与其他滤波函数的区别：
  ┌─────────────────────────────────────────────────┐
  │ cv2.blur(img, (5, 5))         ← 元组 (宽, 高)   │
  │ cv2.GaussianBlur(img, (5, 5), 0)  ← 元组        │
  │ cv2.medianBlur(img, 5)        ← 单个数字！      │
  │                                                  │
  │ 因为中值滤波的核必须是正方形，所以只需一个数    │
  └─────────────────────────────────────────────────┘
```

---

## 💻 代码部分

### 代码示例 1：基础中值滤波

```python
import cv2
import numpy as np

# 读取图像
img = cv2.imread("test.jpg")

# 不同核大小的中值滤波
# 注意：参数是单个数字，不是元组！
median_3 = cv2.medianBlur(img, 3)
median_5 = cv2.medianBlur(img, 5)
median_9 = cv2.medianBlur(img, 9)
median_15 = cv2.medianBlur(img, 15)

# 显示结果
cv2.imshow("Original", img)
cv2.imshow("Median 3", median_3)
cv2.imshow("Median 5", median_5)
cv2.imshow("Median 9", median_9)
cv2.imshow("Median 15", median_15)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

### 代码示例 2：中值滤波 vs 椒盐噪声（效果惊艳！）

```python
import cv2
import numpy as np

def add_salt_pepper_noise(image, amount=0.05):
    """添加椒盐噪声"""
    noisy = image.copy()
    h, w = image.shape[:2]
    num_noise = int(h * w * amount)

    # 盐（白点）
    for _ in range(num_noise):
        y, x = np.random.randint(0, h), np.random.randint(0, w)
        if len(image.shape) == 3:
            noisy[y, x] = [255, 255, 255]
        else:
            noisy[y, x] = 255

    # 胡椒（黑点）
    for _ in range(num_noise):
        y, x = np.random.randint(0, h), np.random.randint(0, w)
        if len(image.shape) == 3:
            noisy[y, x] = [0, 0, 0]
        else:
            noisy[y, x] = 0

    return noisy

# 读取图像
img = cv2.imread("test.jpg")

# 添加 5% 的椒盐噪声
noisy = add_salt_pepper_noise(img, amount=0.05)

# 用不同滤波器处理
blur_result = cv2.blur(noisy, (5, 5))           # 均值滤波
gauss_result = cv2.GaussianBlur(noisy, (5, 5), 0)  # 高斯滤波
median_result = cv2.medianBlur(noisy, 5)         # 中值滤波

# 显示对比
cv2.imshow("Original", img)
cv2.imshow("Salt-Pepper Noisy (5%)", noisy)
cv2.imshow("Blur 5x5", blur_result)
cv2.imshow("Gaussian 5x5", gauss_result)
cv2.imshow("Median 5", median_result)  # 效果最好！
cv2.waitKey(0)
cv2.destroyAllWindows()

# 观察结果：
# - 均值滤波：噪声变成了灰点（被平均了），图像变模糊
# - 高斯滤波：和均值类似，噪声没完全消除
# - 中值滤波：噪声几乎完全消失！边缘还很清晰！
```

---

### 代码示例 3：量化对比不同滤波器对椒盐噪声的效果

```python
import cv2
import numpy as np

def add_salt_pepper_noise(image, amount):
    """添加椒盐噪声"""
    noisy = image.copy()
    h, w = image.shape[:2]
    num = int(h * w * amount)
    for _ in range(num):
        y, x = np.random.randint(0, h), np.random.randint(0, w)
        noisy[y, x] = 255
    for _ in range(num):
        y, x = np.random.randint(0, h), np.random.randint(0, w)
        noisy[y, x] = 0
    return noisy

def psnr(original, processed):
    """计算 PSNR"""
    mse = np.mean((original.astype(float) - processed.astype(float)) ** 2)
    if mse == 0:
        return float('inf')
    return 10 * np.log10(255.0 ** 2 / mse)

# 读取灰度图像
img = cv2.imread("test.jpg", cv2.IMREAD_GRAYSCALE)

# 测试不同噪声强度
print(f"{'噪声比例':<10} {'噪声图PSNR':<12} {'均值5x5':<12} {'高斯5x5':<12} {'中值5':<12}")
print("-" * 60)

for amount in [0.01, 0.03, 0.05, 0.10, 0.20]:
    noisy = add_salt_pepper_noise(img, amount)

    blur = cv2.blur(noisy, (5, 5))
    gauss = cv2.GaussianBlur(noisy, (5, 5), 0)
    median = cv2.medianBlur(noisy, 5)

    p_noisy = psnr(img, noisy)
    p_blur = psnr(img, blur)
    p_gauss = psnr(img, gauss)
    p_median = psnr(img, median)

    print(f"{amount:<10.0%} {p_noisy:<12.2f} {p_blur:<12.2f} {p_gauss:<12.2f} {p_median:<12.2f}")

# 典型输出：
# 噪声比例    噪声图PSNR    均值5x5      高斯5x5      中值5
# ------------------------------------------------------------
# 1%         24.15        27.82        27.65        33.21   ← 中值完胜
# 3%         19.32        25.03        24.89        30.56
# 5%         16.78        23.41        23.28        28.94
# 10%        13.72        20.85        20.74        25.63
# 20%        10.57        17.94        17.86        21.02
#
# 结论：中值滤波对椒盐噪声的 PSNR 比其他滤波高出 5-8 dB！
```

---

### 代码示例 4：中值滤波对高斯噪声的效果（不太好）

```python
import cv2
import numpy as np

def add_gaussian_noise(image, sigma):
    """添加高斯噪声"""
    noise = np.random.normal(0, sigma, image.shape)
    noisy = np.clip(image.astype(float) + noise, 0, 255)
    return noisy.astype(np.uint8)

def psnr(original, processed):
    mse = np.mean((original.astype(float) - processed.astype(float)) ** 2)
    if mse == 0:
        return float('inf')
    return 10 * np.log10(255.0 ** 2 / mse)

# 读取灰度图像
img = cv2.imread("test.jpg", cv2.IMREAD_GRAYSCALE)
noisy = add_gaussian_noise(img, sigma=25)

print("噪声类型：高斯噪声 (σ=25)")
print(f"{'方法':<20} {'PSNR (dB)':<12}")
print("-" * 35)
print(f"{'噪声图像':<20} {psnr(img, noisy):<12.2f}")

for k in [3, 5, 7, 9]:
    gauss = cv2.GaussianBlur(noisy, (k, k), 0)
    median = cv2.medianBlur(noisy, k)

    print(f"{'高斯 ' + str(k) + 'x' + str(k):<20} {psnr(img, gauss):<12.2f}")
    print(f"{'中值 ' + str(k):<20} {psnr(img, median):<12.2f}")

# 典型输出：
# 噪声类型：高斯噪声 (σ=25)
# 方法                  PSNR (dB)
# -----------------------------------
# 噪声图像              20.18
# 高斯 3x3              25.15        ← 高斯更好
# 中值 3                24.82
# 高斯 5x5              26.38        ← 高斯更好
# 中值 5                25.91
# 高斯 7x7              26.12
# 中值 7                25.55
# 高斯 9x9              25.42
# 中值 9                24.83
#
# 结论：对高斯噪声，高斯滤波略优于中值滤波
```

---

### 代码示例 5：中值滤波的边缘保持能力

```python
import cv2
import numpy as np

# 创建一个有清晰边缘的测试图像
img = np.zeros((200, 200), dtype=np.uint8)
img[50:150, 50:150] = 255  # 中间一个白色正方形

# 添加椒盐噪声
noisy = img.copy()
for _ in range(500):
    y, x = np.random.randint(0, 200), np.random.randint(0, 200)
    noisy[y, x] = 255 if np.random.random() > 0.5 else 0

# 不同滤波处理
blur = cv2.blur(noisy, (5, 5))
gauss = cv2.GaussianBlur(noisy, (5, 5), 0)
median = cv2.medianBlur(noisy, 5)

# 计算边缘（用于对比边缘保持效果）
edge_orig = cv2.Canny(img, 100, 200)
edge_blur = cv2.Canny(blur, 100, 200)
edge_gauss = cv2.Canny(gauss, 100, 200)
edge_median = cv2.Canny(median, 100, 200)

# 显示
cv2.imshow("Original", img)
cv2.imshow("Noisy", noisy)
cv2.imshow("Blur", blur)
cv2.imshow("Gaussian", gauss)
cv2.imshow("Median", median)

cv2.imshow("Edge - Original", edge_orig)
cv2.imshow("Edge - Blur", edge_blur)
cv2.imshow("Edge - Gaussian", edge_gauss)
cv2.imshow("Edge - Median", edge_median)  # 边缘最接近原图！

cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

### 代码示例 6：迭代中值滤波去除严重噪声

```python
import cv2
import numpy as np

def add_salt_pepper_noise(image, amount):
    noisy = image.copy()
    h, w = image.shape[:2]
    num = int(h * w * amount)
    for _ in range(num):
        y, x = np.random.randint(0, h), np.random.randint(0, w)
        noisy[y, x] = 255
    for _ in range(num):
        y, x = np.random.randint(0, h), np.random.randint(0, w)
        noisy[y, x] = 0
    return noisy

# 读取图像
img = cv2.imread("test.jpg", cv2.IMREAD_GRAYSCALE)

# 添加严重的椒盐噪声（20%）
noisy = add_salt_pepper_noise(img, 0.20)

# 单次大核 vs 多次小核
single_large = cv2.medianBlur(noisy, 9)

multi_small = noisy.copy()
for _ in range(3):
    multi_small = cv2.medianBlur(multi_small, 5)

# 显示对比
cv2.imshow("Original", img)
cv2.imshow("Heavy Noise (20%)", noisy)
cv2.imshow("Single Median 9", single_large)
cv2.imshow("3x Median 5", multi_small)
cv2.waitKey(0)
cv2.destroyAllWindows()

# 结论：
# - 单次大核：可能丢失细节
# - 多次小核：逐步去噪，保留更多细节
# - 对于严重噪声，可以先用小核多次，再根据需要调整
```

---

## 📝 本节小结

```
中值滤波 - 知识脑图：

  中值滤波 (cv2.medianBlur)
  │
  ├── 原理
  │   ├── 非线性滤波（需要排序）
  │   ├── 取邻域像素的中间值
  │   └── 极端值被挤到两端，无法成为结果
  │
  ├── 特点
  │   ├── 对椒盐噪声效果极佳（几乎完美）
  │   ├── 边缘保持效果好
  │   ├── 计算速度较慢（需排序）
  │   └── 结果一定是邻域中已存在的值
  │
  ├── 适用场景
  │   ├── ✅ 椒盐噪声（首选！）
  │   ├── ✅ 脉冲噪声
  │   ├── △ 高斯噪声（不如高斯滤波）
  │   └── △ 细小线条（可能被消除）
  │
  ├── 函数
  │   └── cv2.medianBlur(img, ksize)
  │       └── ksize 是单个奇数（3,5,7...），不是元组！
  │
  └── 技巧
      ├── 椒盐噪声 → 优先用中值滤波
      ├── 严重噪声 → 多次小核迭代
      └── 混合噪声 → 先中值再高斯
```

> 💡 **关键要点：**
> 1. `cv2.medianBlur(img, 5)` — 参数是单个数字，不是元组！
> 2. 中值滤波是椒盐噪声的克星，效果远超均值和高斯滤波
> 3. 中值滤波能保持边缘，因为结果一定是邻域中已有的值
> 4. 但中值滤波速度较慢，对高斯噪声效果一般
> 5. 可以先中值去除椒盐噪声，再高斯去除剩余噪声

---

👉 [上一节：高斯滤波](../03-高斯滤波/高斯滤波.md) | [返回章节目录](../图像滤波.md) | [下一节：双边滤波](../05-双边滤波/双边滤波.md)
