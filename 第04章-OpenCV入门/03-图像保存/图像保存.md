# å›¾åƒä¿å­˜

> å¤„ç†å®Œå›¾åƒåï¼Œä¸‹ä¸€æ­¥å°±æ˜¯æŠŠç»“æœä¿å­˜ä¸‹æ¥ã€‚ä¸åŒçš„ä¿å­˜æ ¼å¼å’Œå‚æ•°è®¾ç½®ï¼Œç›´æ¥å½±å“æ–‡ä»¶å¤§å°å’Œå›¾åƒè´¨é‡ã€‚ç†è§£è¿™äº›å·®å¼‚ï¼Œèƒ½å¸®ä½ åœ¨"è´¨é‡"å’Œ"ä½“ç§¯"ä¹‹é—´æ‰¾åˆ°æœ€ä½³å¹³è¡¡ã€‚

---

## ğŸ“– ç†è®ºéƒ¨åˆ†

### 1. åŸºæœ¬ä¿å­˜ï¼šcv2.imwrite()

#### 1.1 åŸºæœ¬è¯­æ³•

```python
import cv2

# åŸºæœ¬ç”¨æ³•
success = cv2.imwrite("output.jpg", img)

# å®Œæ•´è¯­æ³•
success = cv2.imwrite(filename, img, params=None)
# filename: è¾“å‡ºæ–‡ä»¶è·¯å¾„ï¼ˆé€šè¿‡æ‰©å±•åå†³å®šæ ¼å¼ï¼ï¼‰
# img:      è¦ä¿å­˜çš„å›¾åƒï¼ˆNumPy æ•°ç»„ï¼‰
# params:   å‹ç¼©å‚æ•°ï¼ˆå¯é€‰ï¼‰
# è¿”å›å€¼:   True=æˆåŠŸ, False=å¤±è´¥
```

> ğŸ’¡ **å…³é”®ç‚¹ï¼š** OpenCV é€šè¿‡**æ–‡ä»¶æ‰©å±•å**è‡ªåŠ¨åˆ¤æ–­ä¿å­˜æ ¼å¼ã€‚å†™ `.jpg` å°±ä¿å­˜ä¸º JPEGï¼Œå†™ `.png` å°±ä¿å­˜ä¸º PNGã€‚

```python
import cv2
import numpy as np

# åˆ›å»ºæµ‹è¯•å›¾åƒ
img = np.random.randint(0, 256, (480, 640, 3), dtype=np.uint8)

# ä¿å­˜ä¸ºä¸åŒæ ¼å¼ï¼ˆæ‰©å±•åå†³å®šæ ¼å¼ï¼‰
cv2.imwrite("output.jpg", img)     # JPEG æ ¼å¼
cv2.imwrite("output.png", img)     # PNG æ ¼å¼
cv2.imwrite("output.bmp", img)     # BMP æ ¼å¼
cv2.imwrite("output.webp", img)    # WebP æ ¼å¼

# æ£€æŸ¥ä¿å­˜æ˜¯å¦æˆåŠŸ
success = cv2.imwrite("output.jpg", img)
if success:
    print("ä¿å­˜æˆåŠŸï¼")
else:
    print("ä¿å­˜å¤±è´¥ï¼è¯·æ£€æŸ¥è·¯å¾„å’Œæƒé™")
```

#### 1.2 ä¸­æ–‡è·¯å¾„ä¿å­˜é—®é¢˜

å’Œ `imread` ä¸€æ ·ï¼Œ`imwrite` ä¹Ÿå¯èƒ½ä¸æ”¯æŒä¸­æ–‡è·¯å¾„ï¼š

```python
import cv2
import numpy as np

# âŒ å¯èƒ½å¤±è´¥
cv2.imwrite("D:/å›¾ç‰‡/ç»“æœ.jpg", img)

# âœ… æ”¯æŒä¸­æ–‡è·¯å¾„çš„ä¿å­˜æ–¹æ³•
def imwrite_chinese(filepath, img, params=None):
    """æ”¯æŒä¸­æ–‡è·¯å¾„çš„å›¾åƒä¿å­˜"""
    ext = filepath.split('.')[-1]
    encode_param = [int(cv2.IMWRITE_JPEG_QUALITY), 95] if ext in ['jpg', 'jpeg'] else None
    if params is not None:
        encode_param = params
    success, encoded = cv2.imencode('.' + ext, img, encode_param)
    if success:
        encoded.tofile(filepath)
        return True
    return False

# ä½¿ç”¨
imwrite_chinese("D:/å›¾ç‰‡/ç»“æœ.jpg", img)
```

---

### 2. å›¾åƒæ ¼å¼è¯¦è§£

#### 2.1 å¸¸ç”¨æ ¼å¼å¯¹æ¯”

| æ ¼å¼ | å‹ç¼©æ–¹å¼ | é€æ˜é€šé“ | æ–‡ä»¶å¤§å° | é€‚ç”¨åœºæ™¯ |
|------|---------|---------|---------|---------|
| **JPEG** (.jpg) | æœ‰æŸ | âŒ ä¸æ”¯æŒ | å° | ç…§ç‰‡ã€ç½‘é¡µå›¾ç‰‡ |
| **PNG** (.png) | æ— æŸ | âœ… æ”¯æŒ | ä¸­ | æˆªå›¾ã€éœ€è¦é€æ˜çš„å›¾ç‰‡ |
| **BMP** (.bmp) | æ— å‹ç¼© | âŒ ä¸æ”¯æŒ | å¤§ | ä¸´æ—¶å­˜å‚¨ã€å¿«é€Ÿè¯»å†™ |
| **TIFF** (.tif) | å¯é€‰ | âœ… æ”¯æŒ | å¤§ | åŒ»å­¦å½±åƒã€é«˜è´¨é‡å­˜æ¡£ |
| **WebP** (.webp) | æœ‰æŸ/æ— æŸ | âœ… æ”¯æŒ | å° | ç°ä»£ç½‘é¡µå›¾ç‰‡ |

```
æ–‡ä»¶å¤§å°å¯¹æ¯”ï¼ˆåŒä¸€å¼  1920Ã—1080 å½©è‰²å›¾åƒï¼‰ï¼š

BMP:   çº¦ 5.9 MB   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
TIFF:  çº¦ 5.9 MB   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
PNG:   çº¦ 2.5 MB   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
JPEG:  çº¦ 0.3 MB   â–ˆâ–ˆ
WebP:  çº¦ 0.2 MB   â–ˆ

JPEG å’Œ WebP æ–‡ä»¶ä½“ç§¯åªæœ‰ BMP çš„ 5%ï¼
ä½†ä»£ä»·æ˜¯æœ‰æŸå‹ç¼©ï¼ˆè‚‰çœ¼å‡ ä¹çœ‹ä¸å‡ºåŒºåˆ«ï¼‰
```

#### 2.2 JPEG æ ¼å¼è¯¦è§£

JPEG æ˜¯æœ€å¸¸ç”¨çš„å›¾åƒæ ¼å¼ï¼Œä½¿ç”¨æœ‰æŸå‹ç¼©ï¼š

```python
import cv2
import numpy as np

img = np.random.randint(0, 256, (480, 640, 3), dtype=np.uint8)

# JPEG è´¨é‡å‚æ•°ï¼š0~100ï¼Œå€¼è¶Šå¤§è´¨é‡è¶Šé«˜ã€æ–‡ä»¶è¶Šå¤§
# é»˜è®¤å€¼æ˜¯ 95

# æœ€é«˜è´¨é‡ï¼ˆæ–‡ä»¶æœ€å¤§ï¼‰
cv2.imwrite("high_quality.jpg", img,
            [cv2.IMWRITE_JPEG_QUALITY, 100])

# é»˜è®¤è´¨é‡
cv2.imwrite("default_quality.jpg", img,
            [cv2.IMWRITE_JPEG_QUALITY, 95])

# ä¸­ç­‰è´¨é‡
cv2.imwrite("medium_quality.jpg", img,
            [cv2.IMWRITE_JPEG_QUALITY, 50])

# æœ€ä½è´¨é‡ï¼ˆæ–‡ä»¶æœ€å°ï¼Œè´¨é‡æœ€å·®ï¼‰
cv2.imwrite("low_quality.jpg", img,
            [cv2.IMWRITE_JPEG_QUALITY, 1])
```

```
JPEG è´¨é‡ä¸æ–‡ä»¶å¤§å°çš„å…³ç³»ï¼š

è´¨é‡=100:  æ–‡ä»¶å¤§ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  è´¨é‡æœ€å¥½
è´¨é‡= 95:  æ–‡ä»¶ä¸­ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ            é»˜è®¤ï¼Œæ¨è
è´¨é‡= 75:  æ–‡ä»¶ä¸­ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                 ç½‘é¡µå›¾ç‰‡å¸¸ç”¨
è´¨é‡= 50:  æ–‡ä»¶å° â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                    å¯æ¥å—
è´¨é‡= 10:  æ–‡ä»¶å° â–ˆâ–ˆ                       æ˜æ˜¾æ¨¡ç³Š
è´¨é‡=  1:  æ–‡ä»¶å° â–ˆ                        ä¸¥é‡å¤±çœŸ

å»ºè®®ï¼š
- å­˜æ¡£/æ‰“å° â†’ 95~100
- æ™®é€šä½¿ç”¨ â†’ 75~90
- ç½‘é¡µ/ç¼©ç•¥å›¾ â†’ 50~75
```

> âš ï¸ **JPEG ä¸æ”¯æŒé€æ˜é€šé“ï¼** å¦‚æœä¿å­˜çš„å›¾åƒæœ‰ Alpha é€šé“ï¼ˆshape ä¸º `(H,W,4)`ï¼‰ï¼ŒJPEG ä¼šè‡ªåŠ¨ä¸¢å¼ƒé€æ˜é€šé“ã€‚éœ€è¦é€æ˜é€šé“è¯·ç”¨ PNGã€‚

#### 2.3 PNG æ ¼å¼è¯¦è§£

PNG ä½¿ç”¨æ— æŸå‹ç¼©ï¼Œé€‚åˆéœ€è¦ç²¾ç¡®åƒç´ å€¼çš„åœºæ™¯ï¼š

```python
# PNG å‹ç¼©çº§åˆ«ï¼š0~9ï¼Œå€¼è¶Šå¤§å‹ç¼©è¶Šå¤šã€ä¿å­˜è¶Šæ…¢
# é»˜è®¤å€¼æ˜¯ 3
# æ³¨æ„ï¼šæ— è®ºå‹ç¼©çº§åˆ«å¤šå°‘ï¼Œè§£å‹åå›¾åƒå®Œå…¨ä¸€è‡´ï¼ˆæ— æŸï¼ï¼‰

# ä¸å‹ç¼©ï¼ˆä¿å­˜å¿«ï¼Œæ–‡ä»¶å¤§ï¼‰
cv2.imwrite("no_compress.png", img,
            [cv2.IMWRITE_PNG_COMPRESSION, 0])

# é»˜è®¤å‹ç¼©
cv2.imwrite("default.png", img,
            [cv2.IMWRITE_PNG_COMPRESSION, 3])

# æœ€é«˜å‹ç¼©ï¼ˆä¿å­˜æ…¢ï¼Œæ–‡ä»¶å°ï¼‰
cv2.imwrite("max_compress.png", img,
            [cv2.IMWRITE_PNG_COMPRESSION, 9])
```

```
PNG å‹ç¼©çº§åˆ«å¯¹æ¯”ï¼š

çº§åˆ«  æ–‡ä»¶å¤§å°  ä¿å­˜é€Ÿåº¦  å›¾åƒè´¨é‡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 0    æœ€å¤§      æœ€å¿«      å®Œå…¨æ— æŸ
 3    ä¸­ç­‰      è¾ƒå¿«      å®Œå…¨æ— æŸï¼ˆé»˜è®¤ï¼‰
 9    æœ€å°      æœ€æ…¢      å®Œå…¨æ— æŸ

å…³é”®ç†è§£ï¼šPNG ä¸ç®¡æ€ä¹ˆå‹ç¼©ï¼Œè§£å‹åå›¾åƒéƒ½æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼
å‹ç¼©çº§åˆ«åªå½±å“"æ–‡ä»¶å¤§å°"å’Œ"ä¿å­˜é€Ÿåº¦"ï¼Œä¸å½±å“å›¾åƒè´¨é‡ã€‚
è¿™å’Œ JPEG æœ‰æœ¬è´¨åŒºåˆ«ï¼
```

**ä¿å­˜å¸¦é€æ˜é€šé“çš„ PNGï¼š**

```python
# åˆ›å»ºä¸€ä¸ªå¸¦é€æ˜é€šé“çš„å›¾åƒ
h, w = 200, 300
bgra = np.zeros((h, w, 4), dtype=np.uint8)

# ç”»ä¸€ä¸ªåŠé€æ˜çš„è“è‰²åœ†å½¢åŒºåŸŸ
bgra[:, :, 0] = 255        # B = 255
bgra[:, :, 3] = 128        # Alpha = 128ï¼ˆåŠé€æ˜ï¼‰

# ä¿å­˜ä¸º PNGï¼ˆä¿ç•™é€æ˜é€šé“ï¼‰
cv2.imwrite("transparent.png", bgra)

# éªŒè¯
loaded = cv2.imread("transparent.png", cv2.IMREAD_UNCHANGED)
print(f"shape: {loaded.shape}")   # (200, 300, 4) â€” 4é€šé“
```

#### 2.4 WebP æ ¼å¼

```python
# WebP åŒæ—¶æ”¯æŒæœ‰æŸå’Œæ— æŸå‹ç¼©

# æœ‰æŸå‹ç¼©ï¼ˆç±»ä¼¼JPEGï¼Œä½†å‹ç¼©ç‡æ›´é«˜ï¼‰
cv2.imwrite("lossy.webp", img,
            [cv2.IMWRITE_WEBP_QUALITY, 80])    # 1~100

# æ— æŸå‹ç¼©ï¼ˆquality=101 è¡¨ç¤ºæ— æŸï¼‰
cv2.imwrite("lossless.webp", img,
            [cv2.IMWRITE_WEBP_QUALITY, 101])
```

---

### 3. æœ‰æŸ vs æ— æŸå‹ç¼©

```
æœ‰æŸå‹ç¼©ï¼ˆJPEGï¼‰ï¼š
  åŸå§‹æ•°æ® â†’ å‹ç¼©ï¼ˆä¸¢æ‰éƒ¨åˆ†ä¿¡æ¯ï¼‰â†’ è§£å‹ â†’ è¿‘ä¼¼æ•°æ®
  ä¼˜ç‚¹ï¼šæ–‡ä»¶éå¸¸å°
  ç¼ºç‚¹ï¼šæ¯æ¬¡ä¿å­˜éƒ½ä¼šæŸå¤±ä¸€ç‚¹è´¨é‡ï¼ˆä¸å¯é€†ï¼ï¼‰

  âš ï¸ åå¤ä¿å­˜ JPEG ä¼šå¯¼è‡´è´¨é‡ä¸æ–­ä¸‹é™ï¼ï¼ˆä»£é™…æŸå¤±ï¼‰
  åŸå›¾ â†’ ä¿å­˜JPEG â†’ è¯»å– â†’ å†ä¿å­˜JPEG â†’ è¯»å– â†’ ... â†’ è´¨é‡è¶Šæ¥è¶Šå·®

æ— æŸå‹ç¼©ï¼ˆPNGï¼‰ï¼š
  åŸå§‹æ•°æ® â†’ å‹ç¼©ï¼ˆä¸ä¸¢ä¿¡æ¯ï¼‰â†’ è§£å‹ â†’ åŸå§‹æ•°æ®ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰
  ä¼˜ç‚¹ï¼šä¿å­˜å¤šå°‘æ¬¡éƒ½ä¸æŸå¤±è´¨é‡
  ç¼ºç‚¹ï¼šæ–‡ä»¶æ¯”JPEGå¤§

æ— å‹ç¼©ï¼ˆBMPï¼‰ï¼š
  åŸå§‹æ•°æ® â†’ ç›´æ¥å†™å…¥æ–‡ä»¶
  ä¼˜ç‚¹ï¼šè¯»å†™æœ€å¿«
  ç¼ºç‚¹ï¼šæ–‡ä»¶æœ€å¤§
```

```python
# éªŒè¯æœ‰æŸ vs æ— æŸ
import cv2
import numpy as np

# åˆ›å»ºæµ‹è¯•å›¾åƒ
original = np.random.randint(0, 256, (100, 100), dtype=np.uint8)

# ä¿å­˜ä¸º JPEG å†è¯»å–
cv2.imwrite("test.jpg", original, [cv2.IMWRITE_JPEG_QUALITY, 50])
jpeg_loaded = cv2.imread("test.jpg", 0)

# ä¿å­˜ä¸º PNG å†è¯»å–
cv2.imwrite("test.png", original)
png_loaded = cv2.imread("test.png", 0)

# æ¯”è¾ƒå·®å¼‚
jpeg_diff = np.sum(original != jpeg_loaded)   # JPEG ä¼šæœ‰å·®å¼‚
png_diff = np.sum(original != png_loaded)     # PNG å®Œå…¨ä¸€è‡´

print(f"JPEG ä¸åŒçš„åƒç´ æ•°: {jpeg_diff}")       # > 0 ï¼ˆæœ‰æŸå¤±ï¼‰
print(f"PNG  ä¸åŒçš„åƒç´ æ•°: {png_diff}")         # = 0 ï¼ˆæ— æŸå¤±ï¼‰
print(f"JPEG æœ€å¤§è¯¯å·®: {np.max(np.abs(original.astype(int) - jpeg_loaded.astype(int)))}")
```

---

### 4. æ ¼å¼é€‰æ‹©æŒ‡å—

```
ä½ åº”è¯¥ç”¨ä»€ä¹ˆæ ¼å¼ï¼Ÿ

å¼€å§‹
  â”‚
  â”œâ”€â”€ éœ€è¦é€æ˜é€šé“ï¼Ÿ â”€â”€â”€â”€ æ˜¯ â”€â”€â†’ PNG
  â”‚                              ï¼ˆæˆ– WebP æ— æŸï¼‰
  â”‚
  â”œâ”€â”€ éœ€è¦ç²¾ç¡®åƒç´ å€¼ï¼Ÿ â”€â”€ æ˜¯ â”€â”€â†’ PNG
  â”‚   ï¼ˆç§‘å­¦è®¡ç®—/æ©è†œï¼‰          ï¼ˆæ— æŸï¼Œåƒç´ å®Œå…¨ä¸€è‡´ï¼‰
  â”‚
  â”œâ”€â”€ ä¸­é—´å¤„ç†ç»“æœï¼Ÿ â”€â”€â”€â”€ æ˜¯ â”€â”€â†’ PNG æˆ– NumPy (.npy)
  â”‚   ï¼ˆè¿˜è¦ç»§ç»­å¤„ç†ï¼‰          ï¼ˆé¿å…æœ‰æŸå‹ç¼©ç´¯ç§¯è¯¯å·®ï¼‰
  â”‚
  â”œâ”€â”€ æœ€ç»ˆå±•ç¤º/ç½‘é¡µï¼Ÿ â”€â”€ æ˜¯ â”€â”€â†’ JPEG (quality=85~95)
  â”‚                              ï¼ˆæˆ– WebPï¼Œæ–‡ä»¶æ›´å°ï¼‰
  â”‚
  â””â”€â”€ å¿«é€Ÿä¸´æ—¶å­˜å‚¨ï¼Ÿ â”€â”€â”€â”€ æ˜¯ â”€â”€â†’ BMPï¼ˆæœ€å¿«ï¼‰
                                  æˆ– NumPy (.npy)
```

---

## ğŸ’» ä»£ç å®æˆ˜

### å®æˆ˜ç»ƒä¹ ï¼šå›¾åƒä¿å­˜æ ¼å¼å¯¹æ¯”

```python
# ===================================================================
# å®æˆ˜ç»ƒä¹ ï¼šå›¾åƒä¿å­˜æ ¼å¼å¯¹æ¯”
# ç›®æ ‡ï¼šå¯¹æ¯”ä¸åŒæ ¼å¼å’Œå‚æ•°çš„æ•ˆæœ
# ===================================================================

import cv2
import numpy as np
import os

# ---------- 1. åˆ›å»ºæµ‹è¯•å›¾åƒ ----------
print("=" * 55)
print("ğŸ¨ ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæµ‹è¯•å›¾åƒ")
print("=" * 55)

np.random.seed(42)
# åˆ›å»ºä¸€å¼ æœ‰ç»†èŠ‚çš„æµ‹è¯•å›¾åƒ
img = np.zeros((300, 400, 3), dtype=np.uint8)

# æ¸å˜èƒŒæ™¯
for y in range(300):
    for x in range(400):
        img[y, x] = [int(x * 255 / 399), int(y * 255 / 299), 128]

# åŠ ä¸€äº›éšæœºå™ªç‚¹å¢åŠ å¤æ‚åº¦
noise = np.random.randint(-20, 20, img.shape, dtype=np.int16)
img = np.clip(img.astype(np.int16) + noise, 0, 255).astype(np.uint8)

print(f"  æµ‹è¯•å›¾åƒ: shape={img.shape}, dtype={img.dtype}")
print(f"  åƒç´ æ€»æ•°: {img.size:,}")

# ---------- 2. ä¸åŒæ ¼å¼ä¿å­˜ ----------
print("\n" + "=" * 55)
print("ğŸ“ ç¬¬äºŒæ­¥ï¼šä¸åŒæ ¼å¼ä¿å­˜å¯¹æ¯”")
print("=" * 55)

formats = {
    "test_output.bmp": None,
    "test_output.png": [cv2.IMWRITE_PNG_COMPRESSION, 3],
    "test_output.jpg": [cv2.IMWRITE_JPEG_QUALITY, 95],
    "test_output.webp": [cv2.IMWRITE_WEBP_QUALITY, 80],
}

print(f"\n  {'æ ¼å¼':<20s} {'æ–‡ä»¶å¤§å°':>10s} {'å‹ç¼©æ¯”':>8s}")
print("  " + "-" * 40)

raw_size = img.nbytes   # åŸå§‹æ•°æ®å¤§å°
for filepath, params in formats.items():
    if params:
        cv2.imwrite(filepath, img, params)
    else:
        cv2.imwrite(filepath, img)

    file_size = os.path.getsize(filepath)
    ratio = file_size / raw_size * 100
    ext = filepath.split('.')[-1].upper()
    print(f"  {ext:<20s} {file_size:>10,} B  {ratio:>6.1f}%")

# ---------- 3. JPEG ä¸åŒè´¨é‡å¯¹æ¯” ----------
print("\n" + "=" * 55)
print("ğŸ“Š ç¬¬ä¸‰æ­¥ï¼šJPEG è´¨é‡å‚æ•°å¯¹æ¯”")
print("=" * 55)

qualities = [1, 10, 25, 50, 75, 90, 95, 100]
print(f"\n  {'è´¨é‡':>4s} {'æ–‡ä»¶å¤§å°':>10s} {'å‹ç¼©æ¯”':>8s} {'vsåŸå§‹è¯¯å·®':>10s}  å¯è§†åŒ–")
print("  " + "-" * 56)

for q in qualities:
    filepath = f"test_q{q}.jpg"
    cv2.imwrite(filepath, img, [cv2.IMWRITE_JPEG_QUALITY, q])
    file_size = os.path.getsize(filepath)
    ratio = file_size / raw_size * 100

    # è¯»å›æ¥è®¡ç®—è¯¯å·®
    loaded = cv2.imread(filepath)
    diff = np.mean(np.abs(img.astype(float) - loaded.astype(float)))

    bar = "â–ˆ" * int(ratio / 3)
    print(f"  {q:>4d} {file_size:>10,} B  {ratio:>6.1f}%  {diff:>8.2f}  {bar}")

    os.remove(filepath)

# ---------- 4. PNG å‹ç¼©çº§åˆ«å¯¹æ¯” ----------
print("\n" + "=" * 55)
print("ğŸ“Š ç¬¬å››æ­¥ï¼šPNG å‹ç¼©çº§åˆ«å¯¹æ¯”")
print("=" * 55)

levels = [0, 1, 3, 5, 9]
print(f"\n  {'çº§åˆ«':>4s} {'æ–‡ä»¶å¤§å°':>10s} {'å‹ç¼©æ¯”':>8s} {'æœ‰æŸå¤±?':>8s}")
print("  " + "-" * 36)

for level in levels:
    filepath = f"test_png{level}.png"
    cv2.imwrite(filepath, img, [cv2.IMWRITE_PNG_COMPRESSION, level])
    file_size = os.path.getsize(filepath)
    ratio = file_size / raw_size * 100

    loaded = cv2.imread(filepath)
    is_lossless = np.array_equal(img, loaded)

    print(f"  {level:>4d} {file_size:>10,} B  {ratio:>6.1f}%  "
          f"{'æ— æŸ âœ…' if is_lossless else 'æœ‰æŸ âŒ'}")

    os.remove(filepath)

# ---------- 5. æœ‰æŸå‹ç¼©ç´¯ç§¯æ•ˆåº” ----------
print("\n" + "=" * 55)
print("ğŸ”„ ç¬¬äº”æ­¥ï¼šJPEG åå¤ä¿å­˜çš„è´¨é‡æŸå¤±")
print("=" * 55)

current = img.copy()
print(f"\n  {'ä¿å­˜æ¬¡æ•°':>8s} {'å¹³å‡è¯¯å·®':>10s} {'æœ€å¤§è¯¯å·®':>10s}")
print("  " + "-" * 32)

for i in range(1, 11):
    cv2.imwrite("temp_repeated.jpg", current, [cv2.IMWRITE_JPEG_QUALITY, 75])
    current = cv2.imread("temp_repeated.jpg")

    diff_mean = np.mean(np.abs(img.astype(float) - current.astype(float)))
    diff_max = np.max(np.abs(img.astype(int) - current.astype(int)))
    print(f"  {i:>8d} {diff_mean:>10.2f} {diff_max:>10d}")

os.remove("temp_repeated.jpg")
print("\n  ç»“è®ºï¼šJPEG åå¤ä¿å­˜ä¼šå¯¼è‡´è´¨é‡æŒç»­ä¸‹é™ï¼")
print("  å¤„ç†ä¸­é—´ç»“æœåº”ä½¿ç”¨ PNG æˆ– NumPy (.npy) ä¿å­˜ã€‚")

# ---------- 6. NumPy æ ¼å¼ä¿å­˜ï¼ˆæ¨èç”¨äºä¸­é—´ç»“æœï¼‰----------
print("\n" + "=" * 55)
print("ğŸ’¾ ç¬¬å…­æ­¥ï¼šNumPy æ ¼å¼ä¿å­˜")
print("=" * 55)

# ä¿å­˜ä¸º .npyï¼ˆå•ä¸ªæ•°ç»„ï¼‰
np.save("test_image.npy", img)
npy_size = os.path.getsize("test_image.npy")

# ä¿å­˜ä¸º .npzï¼ˆå¤šä¸ªæ•°ç»„æ‰“åŒ…ï¼‰
gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
np.savez("test_dataset.npz", image=img, gray=gray)
npz_size = os.path.getsize("test_dataset.npz")

# å‹ç¼©ä¿å­˜
np.savez_compressed("test_compressed.npz", image=img, gray=gray)
npzc_size = os.path.getsize("test_compressed.npz")

print(f"  .npy å¤§å°:          {npy_size:>10,} B")
print(f"  .npz å¤§å°:          {npz_size:>10,} B")
print(f"  .npz å‹ç¼©å:        {npzc_size:>10,} B")

# è¯»å–éªŒè¯
loaded_npy = np.load("test_image.npy")
print(f"\n  .npy æ— æŸ? {np.array_equal(img, loaded_npy)}")

loaded_npz = np.load("test_dataset.npz")
print(f"  .npz åŒ…å«: {list(loaded_npz.keys())}")
print(f"  .npz æ— æŸ? {np.array_equal(img, loaded_npz['image'])}")

# æ¸…ç†
for f in ["test_image.npy", "test_dataset.npz", "test_compressed.npz"]:
    os.remove(f)
for f in list(formats.keys()):
    if os.path.exists(f):
        os.remove(f)

print("\nâœ… å›¾åƒä¿å­˜ç»ƒä¹ å®Œæˆï¼å·²æ¸…ç†ä¸´æ—¶æ–‡ä»¶ã€‚")
```

**è¿è¡Œè¾“å‡ºç¤ºä¾‹ï¼š**

```
=======================================================
ğŸ“ ç¬¬äºŒæ­¥ï¼šä¸åŒæ ¼å¼ä¿å­˜å¯¹æ¯”
=======================================================

  æ ¼å¼                   æ–‡ä»¶å¤§å°     å‹ç¼©æ¯”
  ----------------------------------------
  BMP                   360,054 B   100.0%
  PNG                   328,415 B    91.2%
  JPG                    38,256 B    10.6%
  WEBP                   24,818 B     6.9%

=======================================================
ğŸ“Š ç¬¬ä¸‰æ­¥ï¼šJPEG è´¨é‡å‚æ•°å¯¹æ¯”
=======================================================

  è´¨é‡    æ–‡ä»¶å¤§å°     å‹ç¼©æ¯”   vsåŸå§‹è¯¯å·®  å¯è§†åŒ–
  --------------------------------------------------------
     1      3,857 B     1.1%      12.35
    10      6,542 B     1.8%       5.67
    50     16,823 B     4.7%       2.14  â–ˆ
    95     38,256 B    10.6%       0.65  â–ˆâ–ˆâ–ˆ
   100    112,547 B    31.3%       0.00  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

=======================================================
ğŸ”„ ç¬¬äº”æ­¥ï¼šJPEG åå¤ä¿å­˜çš„è´¨é‡æŸå¤±
=======================================================

  ä¿å­˜æ¬¡æ•°     å¹³å‡è¯¯å·®     æœ€å¤§è¯¯å·®
  --------------------------------
         1       2.14         28
         5       3.89         45
        10       4.52         52

  ç»“è®ºï¼šJPEG åå¤ä¿å­˜ä¼šå¯¼è‡´è´¨é‡æŒç»­ä¸‹é™ï¼
```

---

## ğŸš¨ å¸¸è§é—®é¢˜ä¸æ˜“é”™ç‚¹

### Q1: imwrite è¿”å› False ä½†æ²¡æŠ¥é”™ï¼Ÿ

```python
# å¸¸è§åŸå› ï¼š
# 1. ç›®å½•ä¸å­˜åœ¨
cv2.imwrite("D:/not_exist_dir/output.jpg", img)  # Falseï¼Œç›®å½•ä¸å­˜åœ¨

# è§£å†³ï¼šå…ˆåˆ›å»ºç›®å½•
import os
os.makedirs("D:/output_dir", exist_ok=True)
cv2.imwrite("D:/output_dir/output.jpg", img)

# 2. æ²¡æœ‰å†™å…¥æƒé™
# 3. ä¸­æ–‡è·¯å¾„ï¼ˆç”¨ imencode + tofile è§£å†³ï¼‰
# 4. æ‰©å±•åä¸åˆæ³•
cv2.imwrite("output.xyz", img)  # Falseï¼Œä¸è®¤è¯† .xyz æ ¼å¼
```

### Q2: JPEG å’Œ PNG æ€ä¹ˆé€‰ï¼Ÿ

```python
# ç®€å•è§„åˆ™ï¼š
# - ç…§ç‰‡/è‡ªç„¶å›¾åƒ â†’ JPEGï¼ˆæ–‡ä»¶å°ï¼‰
# - æˆªå›¾/æ–‡å­—/å›¾æ ‡/éœ€è¦é€æ˜ â†’ PNGï¼ˆæ— æŸï¼‰
# - ä¸­é—´å¤„ç†ç»“æœ â†’ PNG æˆ– .npyï¼ˆé¿å…æœ‰æŸå‹ç¼©ç´¯ç§¯ï¼‰
# - æ©è†œ/äºŒå€¼å›¾ â†’ PNGï¼ˆå¿…é¡»æ— æŸï¼Œå¦åˆ™0/255ä¼šå˜æˆå…¶ä»–å€¼ï¼‰

# âš ï¸ ç‰¹åˆ«æ³¨æ„ï¼šäºŒå€¼æ©è†œåƒä¸‡ä¸èƒ½å­˜JPEGï¼
mask = np.zeros((100, 100), dtype=np.uint8)
mask[20:80, 20:80] = 255

cv2.imwrite("mask.jpg", mask)    # âŒ JPEGä¼šæŠŠ255å˜æˆæ¥è¿‘255çš„å€¼
cv2.imwrite("mask.png", mask)    # âœ… PNGä¿è¯ç²¾ç¡®çš„0å’Œ255

loaded_jpg = cv2.imread("mask.jpg", 0)
loaded_png = cv2.imread("mask.png", 0)
print(f"JPEG å”¯ä¸€å€¼: {np.unique(loaded_jpg)}")  # å¯èƒ½æœ‰å¤šä¸ªå€¼ï¼
print(f"PNG  å”¯ä¸€å€¼: {np.unique(loaded_png)}")   # [0, 255] ç²¾ç¡®
```

### Q3: ä¿å­˜åæ–‡ä»¶ä¸ºä»€ä¹ˆå¾ˆå¤§ï¼Ÿ

```python
# æ£€æŸ¥åŸå› ï¼š
img = cv2.imread("photo.jpg")

# 1. å¯èƒ½æ˜¯ BMP æ ¼å¼ï¼ˆæ— å‹ç¼©ï¼‰
# æ”¹ç”¨ JPEG æˆ– PNG

# 2. PNG å‹ç¼©çº§åˆ«å¤ªä½
cv2.imwrite("out.png", img, [cv2.IMWRITE_PNG_COMPRESSION, 9])

# 3. å›¾åƒæœ¬èº«å¤ªå¤§ï¼Œè€ƒè™‘ç¼©å°
small = cv2.resize(img, (img.shape[1]//2, img.shape[0]//2))
cv2.imwrite("out_small.jpg", small)
```

### Q4: ä¿å­˜æµ®ç‚¹å›¾åƒéœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ

```python
# OpenCV ä¿å­˜ uint8 (0-255) æˆ– uint16 (0-65535)
# æµ®ç‚¹å›¾åƒéœ€è¦å…ˆè½¬æ¢ï¼

float_img = np.random.rand(100, 100).astype(np.float32)  # 0.0~1.0

# âŒ ç›´æ¥ä¿å­˜æµ®ç‚¹æ•° â†’ å…¨é»‘æˆ–å¼‚å¸¸
cv2.imwrite("float.png", float_img)

# âœ… å…ˆè½¬æ¢åˆ° 0~255 å†ä¿å­˜
uint8_img = (float_img * 255).astype(np.uint8)
cv2.imwrite("correct.png", uint8_img)

# âœ… æˆ–è€…ç”¨ NumPy ä¿å­˜æµ®ç‚¹æ•°ï¼ˆç²¾ç¡®ä¿å­˜ï¼‰
np.save("float_image.npy", float_img)
```

---

## ğŸ¯ æ€»ç»“

æœ¬èŠ‚å­¦ä¹ äº† OpenCV çš„å›¾åƒä¿å­˜ï¼š

âœ… **cv2.imwrite()**ï¼šé€šè¿‡æ–‡ä»¶æ‰©å±•åè‡ªåŠ¨é€‰æ‹©æ ¼å¼ï¼Œè¿”å› bool è¡¨ç¤ºæˆåŠŸ/å¤±è´¥
âœ… **JPEG æ ¼å¼**ï¼šæœ‰æŸå‹ç¼©ï¼Œ`IMWRITE_JPEG_QUALITY` æ§åˆ¶è´¨é‡ï¼ˆ0~100ï¼Œé»˜è®¤95ï¼‰
âœ… **PNG æ ¼å¼**ï¼šæ— æŸå‹ç¼©ï¼Œ`IMWRITE_PNG_COMPRESSION` æ§åˆ¶å‹ç¼©çº§åˆ«ï¼ˆ0~9ï¼Œé»˜è®¤3ï¼‰
âœ… **WebP æ ¼å¼**ï¼šæœ‰æŸï¼ˆ1~100ï¼‰æˆ–æ— æŸï¼ˆ101ï¼‰ï¼Œå‹ç¼©ç‡æœ€é«˜
âœ… **æœ‰æŸ vs æ— æŸ**ï¼šJPEG æ¯æ¬¡ä¿å­˜éƒ½æŸå¤±è´¨é‡ï¼ŒPNG ä¿å­˜å¤šå°‘æ¬¡éƒ½ä¸€æ ·
âœ… **æ ¼å¼é€‰æ‹©**ï¼šç…§ç‰‡â†’JPEGï¼Œæˆªå›¾/æ©è†œ/ä¸­é—´ç»“æœâ†’PNGï¼Œå¿«é€Ÿå­˜å–â†’BMP/.npy
âœ… **ä¸­æ–‡è·¯å¾„**ï¼šç”¨ `imencode` + `tofile` è§£å†³

> ğŸ”‘ **æ ¸å¿ƒè¦ç‚¹ï¼š** æ©è†œå’Œä¸­é—´ç»“æœ**å¿…é¡»ç”¨ PNG**ä¿å­˜ï¼ˆé¿å… JPEG æœ‰æŸå‹ç¼©ç ´åç²¾ç¡®å€¼ï¼‰ï¼Œæœ€ç»ˆå±•ç¤ºå›¾ç‰‡ç”¨ **JPEG**ï¼ˆæ–‡ä»¶å°ï¼‰ã€‚æµ®ç‚¹å›¾åƒä¿å­˜å‰è¦å…ˆè½¬ uint8 æˆ–ç”¨ NumPy çš„ `.npy` æ ¼å¼ã€‚

**ä¸‹ä¸€æ­¥ï¼š**
ğŸ‘‰ [04 - å›¾åƒå±æ€§](../04-å›¾åƒå±æ€§/å›¾åƒå±æ€§.md)

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [OpenCV å®˜æ–¹æ–‡æ¡£ - imwrite](https://docs.opencv.org/4.x/d4/da8/group__imgcodecs.html#gabbc7ef1aa2edfaa87772f1202d67e0ce)
- [OpenCV å®˜æ–¹æ–‡æ¡£ - ImwriteFlags](https://docs.opencv.org/4.x/d8/d6a/group__imgcodecs__flags.html)
- [JPEG vs PNG è¯¦è§£](https://docs.opencv.org/4.x/d4/da8/group__imgcodecs.html)
